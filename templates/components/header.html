<!DOCTYPE html>
<html lang="en">
  <head>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;200;300;400;500;700&display=swap" rel="stylesheet">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    {% block styles %} {{ bootstrap.load_css() }} {% endblock %}
    <link rel="stylesheet" href="../../static/header.css">
    <link rel="stylesheet" href="../../static/global.css">
    <link rel="stylesheet" href="../../static/home.css">
    <link rel="stylesheet" href="../../static/footer.css">
    <link rel="stylesheet" href="../../static/good.css">
    <link rel="stylesheet" href="../../static/payment.css">
    <title>It Step Shop</title>
    <script>

    function toggleVisibility(activeElement, inactiveElement) {

      const inactive = document.querySelector(inactiveElement);
      if (inactive.classList.contains('show')){
        inactive.classList.add('close'); 
      }


      const active = document.querySelector(activeElement);

      if (inactive.classList.contains('close')) {
        active.classList.add('show'); 
      }
    }

      let cartCounterOnPage = 0
      let likeCounter = 0

      function initializeLikesCounter() {
        const likesCounter = document.querySelector('.likes-counter');
        likeCounter = 0;

        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          const item = JSON.parse(localStorage.getItem(key) || "{}");

          if (item.option === "Like") {
            likeCounter += 1;
          }

          const idForGood = document.getElementById(key);
        }

        if (likesCounter) {
          likesCounter.textContent = likeCounter;
        }
      }

      function initializeCartsCounter() {
        const cartsCounter = document.querySelector('.carts-counter');
        cartCounterOnPage = 0;

        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key.startsWith('cart-')) {
            const item = JSON.parse(localStorage.getItem(key) || "{}");

            if (item.option === "Cart") {
              cartCounterOnPage += 1;
            }
          }

          const idForGood = document.getElementById(key);
        }

        if (cartsCounter) {
          cartsCounter.textContent = cartCounterOnPage;
        }
      }

      function animateLike(ID){
        initializeLikesCounter()
        const likeButton = document.querySelector('.like-good-catalog');
        const likeButtonID = document.getElementById(ID);
          
          likeButtonID.classList.add('animate');
          setTimeout(() => {
            likeButtonID.classList.remove('animate');
          }, 450); 
      }

      function animateCart(ID){
        initializeCartsCounter()
        const cartButton = document.querySelector('.cart-good-catalog');
        const cartButtonID = document.getElementById(ID);
          
        cartButtonID.classList.add('animate');
          setTimeout(() => {
            cartButtonID.classList.remove('animate');
          }, 450); 
      }

      document.addEventListener('DOMContentLoaded', () => {
          initializeLikesCounter()
      });

      document.addEventListener('DOMContentLoaded', () => {
          initializeCartsCounter()
      });

      function toggleDropdownLike() {
        const dropdown = document.querySelector('.likeDropdownChild');
        if (dropdown.classList.contains('show')) {
            dropdown.classList.add('close');
            dropdown.classList.remove('show');
            // dropdown.classList.remove('close');
            setTimeout(() => {
                dropdown.classList.remove('close');
            }, 300); 
        } else {
            dropdown.classList.add('show');
        }
      }

      function toggleDropdownCart() {
        const dropdown = document.querySelector('.cartDropdownChild');
        if (dropdown.classList.contains('show')) {
            dropdown.classList.add('close');
            dropdown.classList.remove('show');
            setTimeout(() => {
                dropdown.classList.remove('close');
            }, 300); 
        } else {
            dropdown.classList.add('show');
        }
      }

      async function saveGoodToLocalStorage(ID) {

        const response = await fetch(`/get_good/${ID}`);
        const goodLikeRes = await response.json();
        
        const goodLike = {
            src: goodLikeRes.src,
            name: goodLikeRes.name, 
            code: goodLikeRes.code,
            size: goodLikeRes.size,
            color: goodLikeRes.color,
            price: goodLikeRes.price, 
            id: goodLikeRes.id,
            option: "Like"
        }

        localStorage.setItem(ID, JSON.stringify(goodLike));

        initializeLikesCounter()
        displayLikedItems()
      }

      async function saveGoodToLocalStorageCart(ID) {
        console.log('jjj',ID)

        const response = await fetch(`/get_good_cart/${ID}`);
        const goodCartRes = await response.json();

        const goodCart = {
            src: goodCartRes.src,
            name: goodCartRes.name, 
            code: goodCartRes.code,
            size: goodCartRes.size,
            color: goodCartRes.color,
            price: goodCartRes.price, 
            id: goodCartRes.id,
            option: "Cart"
        }

        localStorage.setItem(ID, JSON.stringify(goodCart));

        initializeCartsCounter()
        displayCartedItems()
      }

      function toggleLike(ID){
        findElementLikeButton = document.getElementById(ID)
        console.log(ID)
        const isLiked = findElementLikeButton.classList.contains('liked');
        findElementLikeButton.classList.toggle('liked')
        const likesCounter = document.querySelector('.likes-counter');

        if (isLiked) {
          localStorage.removeItem(ID)
          likeCounter -= 1;
          likesCounter.textContent = likeCounter;
        } else {
          saveGoodToLocalStorage(ID);
        }
        displayLikedItems()
      }

      function toggleCart(ID){   

          console.log(ID)
          findElementCartButton = document.getElementById(ID)
          const isCarted = findElementCartButton.classList.contains('carted');
          if (window.location.pathname === '/') { 
            findElementCartButton.classList.toggle('carted')
          }
          const cartsCounter = document.querySelector('.carts-counter');
          if (isCarted) {
            localStorage.removeItem(ID)
            cartCounterOnPage -= 1;
            cartsCounter.textContent = cartCounterOnPage;
          } else {
            saveGoodToLocalStorageCart(ID);
          }
          displayCartedItems()
        
      }

      function togglePayment(ID){   
        findElementCartButton = document.getElementById(ID)
        const cartsCounter = document.querySelector('.carts-counter');
          localStorage.removeItem(ID)
          cartCounterOnPage -= 1;
          cartsCounter.textContent = cartCounterOnPage;
        
          initializePaymentPageElement()
      }

      document.addEventListener('DOMContentLoaded', () => {
        displayLikedItems(); 
      });

      document.addEventListener('DOMContentLoaded', () => {
        displayCartedItems(); 
      });

      document.addEventListener('DOMContentLoaded', function() {
        for (let i = 0; i < localStorage.length; i++) {
          const getKeys = localStorage.key(i);
          if (!getKeys.startsWith('cart-')) {
            const item = JSON.parse(localStorage.getItem(getKeys) || "{}");
            const toLikeAfterReload = document.getElementById(getKeys);
            if (item.option === "Like") {
                toLikeAfterReload.classList.add('liked');
            }
          }
        }
      })

      document.addEventListener('DOMContentLoaded', function() {
        for (let i = 0; i < localStorage.length; i++) {
          const getKeys = localStorage.key(i);
          if (getKeys.startsWith('cart-')) {
            const item = JSON.parse(localStorage.getItem(getKeys) || "{}");
            const toCartAfterReload = document.getElementById(getKeys);
            if (item.option === "Cart") {
                  toCartAfterReload.classList.add('carted');
            }
          }
        }
      })
      
      function scrollToCatalog(){
        event.preventDefault(); 
        document.getElementById('catalogTitle').scrollIntoView({
          behavior: 'smooth', 
          block: 'start' 
        });
      }

      function getItemsFromStorage(){
        let listElementsFromStorage = []

        for (let i = 0; i < localStorage.length; i++){
          let itemFromStorageKey = localStorage.key(i)
          let itemFromStorageValye = localStorage.getItem(itemFromStorageKey)
          itemFromStorageValyeParce = JSON.parse(itemFromStorageValye)
          if (itemFromStorageValyeParce.option === "Like"){
            listElementsFromStorage.push(itemFromStorageValyeParce)
          }
        }
        return listElementsFromStorage
      }

      function getItemsFromStorageCart(){
        let listElementsFromStorageCart = []

        for (let i = 0; i < localStorage.length; i++){
          let itemFromStorageKey = localStorage.key(i)
          if (itemFromStorageKey.startsWith('cart-')) {
            let itemFromStorageValye = localStorage.getItem(itemFromStorageKey)
            itemFromStorageValyeParce = JSON.parse(itemFromStorageValye)
            if (itemFromStorageValyeParce.option === "Cart"){
              listElementsFromStorageCart.push(itemFromStorageValyeParce)
            }
          }
        }
        return listElementsFromStorageCart
      }

      function displayLikedItems() {
        const likedItems = getItemsFromStorage();
        const likedGoodsContainer = document.querySelector('.likedGoodsContainer');

        likedGoodsContainer.innerHTML = '';

        if (likedItems.length === 0) {
            likedGoodsContainer.innerHTML = '<div class="likedGoodsContainerTitleNotFound">Іди, шось перше но полайкай</div>';
            return;
        }

        const baseGoodUrl = "{{ url_for('good', id=0) }}".replace("0", "");

        likedItems.forEach(item => {

          const wrapperImgElement = document.createElement('div');
          wrapperImgElement.classList.add('likedGoodsContainerImageWraper');

          const imgElement = document.createElement('img');
          imgElement.src = item.src; 
          imgElement.alt = 'liked good image'; 
          imgElement.classList.add('likedGoodsContainerImage');

          wrapperImgElement.appendChild(imgElement);

          const wrapperInfoElement = document.createElement('div');
          wrapperInfoElement.classList.add('likedGoodsContainerInfoWraper');

          const InfoMainTextElement = document.createElement('a');
          InfoMainTextElement.classList.add('InfoMainTextElement');
          InfoMainTextElement.href = `${baseGoodUrl}${item.id}`;
          InfoMainTextElement.textContent = item.name;
          wrapperInfoElement.appendChild(InfoMainTextElement);

          const wrapperContentElement = document.createElement('div');
          wrapperContentElement.classList.add('likedGoodsContentElement');

          wrapperContentElement.appendChild(wrapperImgElement);
          wrapperContentElement.appendChild(wrapperInfoElement);

          likedGoodsContainer.appendChild(wrapperContentElement);

          const InfoMainCodeElement = document.createElement('h2');
          InfoMainCodeElement.classList.add('InfoMainCodeElement');
          InfoMainCodeElement.innerHTML = `<div class="InfoMainElementWraper">
              <span class="InfoMainCodeElementLabel">Артикул:</span> 
              <span class="InfoMainCodeElementValue">${item.code}</span>
          </div>`;
          wrapperInfoElement.appendChild(InfoMainCodeElement);

          const InfoMainSizeElement = document.createElement('h2');
          InfoMainSizeElement.classList.add('InfoMainSizeElement');
          InfoMainSizeElement.innerHTML = `<div class="InfoMainElementWraper">
              <span class="InfoMainSizeElementLabel">Розмір:</span> 
              <span class="InfoMainSizeElementValue">${item.size}</span>
          </div>`;
          wrapperInfoElement.appendChild(InfoMainSizeElement);

          const InfoColorMainElement = document.createElement('h2');
          InfoColorMainElement.classList.add('InfoColorMainElement');
          InfoColorMainElement.innerHTML = `<div class="InfoMainElementWraper">
              <span class="InfoColorMainElementLabel">Колір:</span> 
              <span class="InfoColorMainElementValue">${item.color}</span>
          </div>`;
          wrapperInfoElement.appendChild(InfoColorMainElement);

          const InfoPriceColorElement = document.createElement('h2');
          InfoPriceColorElement.classList.add('InfoPriceColorElement');
          InfoPriceColorElement.textContent = "$" + item.price;
          wrapperInfoElement.appendChild(InfoPriceColorElement);

          const InfoElementDeleteButton = document.createElement('button');
          InfoElementDeleteButton.classList.add('InfoElementDeleteButton');
          InfoElementDeleteButton.textContent = "Видалити";
          InfoElementDeleteButton.onclick = function () {
            toggleLike(item.id);
          };
          wrapperInfoElement.appendChild(InfoElementDeleteButton);
        });
      }

      function displayCartedItems() {
        const cartedItems = getItemsFromStorageCart();
        const cartedGoodsContainer = document.querySelector('.cartedGoodsContainer');

        cartedGoodsContainer.innerHTML = '';

        if (cartedItems.length === 0) {
            cartedGoodsContainer.innerHTML = '<div class="cartedGoodsContainerTitleNotFound">Ше ніц нема в кошику(</div>';
            return;
        }

        const baseGoodUrl = "{{ url_for('good', id=0) }}".replace("0", "");



        cartedItems.forEach(item => {

          const wrapperImgElement = document.createElement('div');
          wrapperImgElement.classList.add('cartedGoodsContainerImageWraper');

          const imgElement = document.createElement('img');
          imgElement.src = item.src; 
          imgElement.alt = 'carted good image'; 
          imgElement.classList.add('cartedGoodsContainerImage');

          wrapperImgElement.appendChild(imgElement);

          const wrapperInfoElement = document.createElement('div');
          wrapperInfoElement.classList.add('cartedGoodsContainerInfoWraper');

          const InfoMainTextElement = document.createElement('a');
          InfoMainTextElement.classList.add('InfoMainTextElement');
          InfoMainTextElement.href = `${baseGoodUrl}${item.id}`;
          InfoMainTextElement.textContent = item.name;
          wrapperInfoElement.appendChild(InfoMainTextElement);

          const wrapperContentElement = document.createElement('div');
          wrapperContentElement.classList.add('cartedGoodsContentElement');

          wrapperContentElement.appendChild(wrapperImgElement);
          wrapperContentElement.appendChild(wrapperInfoElement);

          cartedGoodsContainer.appendChild(wrapperContentElement);

          const InfoMainCodeElement = document.createElement('h2');
          InfoMainCodeElement.classList.add('InfoMainCodeElement');
          InfoMainCodeElement.innerHTML = `<div class="InfoMainElementWraper">
              <span class="InfoMainCodeElementLabel">Артикул:</span> 
              <span class="InfoMainCodeElementValue">${item.code}</span>
          </div>`;
          wrapperInfoElement.appendChild(InfoMainCodeElement);

          const InfoMainSizeElement = document.createElement('h2');
          InfoMainSizeElement.classList.add('InfoMainSizeElement');
          InfoMainSizeElement.innerHTML = `<div class="InfoMainElementWraper">
              <span class="InfoMainSizeElementLabel">Розмір:</span> 
              <span class="InfoMainSizeElementValue">${item.size}</span>
          </div>`;
          wrapperInfoElement.appendChild(InfoMainSizeElement);

          const InfoColorMainElement = document.createElement('h2');
          InfoColorMainElement.classList.add('InfoColorMainElement');
          InfoColorMainElement.innerHTML = `<div class="InfoMainElementWraper">
              <span class="InfoColorMainElementLabel">Колір:</span> 
              <span class="InfoColorMainElementValue">${item.color}</span>
          </div>`;
          wrapperInfoElement.appendChild(InfoColorMainElement);

          const InfoPriceColorElement = document.createElement('h2');
          InfoPriceColorElement.classList.add('InfoPriceColorElement');
          InfoPriceColorElement.textContent = "$" + item.price;
          wrapperInfoElement.appendChild(InfoPriceColorElement);

          const InfoElementDeleteButton = document.createElement('button');
          InfoElementDeleteButton.classList.add('InfoElementDeleteButton');
          InfoElementDeleteButton.textContent = "Видалити";
          InfoElementDeleteButton.onclick = function () {
            const converToWithTo = "cart-" + item.id;
            toggleCart(converToWithTo);
          };
          wrapperInfoElement.appendChild(InfoElementDeleteButton);
        });
        
        if (typeof cartedItems !== 'undefined' && cartedItems.length > 0) {
          const contentElementButtonWrapper = document.createElement('div');
          contentElementButtonWrapper.innerHTML = '<a class="cartedGoodsContainerButton" href ="{{url_for("payment")}}">Оформити бажання</a>';
          contentElementButtonWrapper.classList.add('cartedGoodsContentElement');
          cartedGoodsContainer.appendChild(contentElementButtonWrapper);
        }
      }

      function initializePaymentPageElement() {
        const cartedItems = getItemsFromStorageCart();
        const cartItemPaymentContainer = document.querySelector('.cart-item-payment-container');

        cartItemPaymentContainer.innerHTML = '';

        const baseGoodUrl = "{{ url_for('good', id=0) }}".replace("0", "");

        cartedItems.forEach(item => {

          const wrapperImgElement = document.createElement('div');
          wrapperImgElement.classList.add('cartedGoodsContainerImageWraper');

          const imgElement = document.createElement('img');
          imgElement.src = item.src; 
          imgElement.alt = 'carted good image'; 
          imgElement.classList.add('cartedGoodsContainerImage');

          wrapperImgElement.appendChild(imgElement);

          const wrapperInfoElement = document.createElement('div');
          wrapperInfoElement.classList.add('cartedGoodsContainerInfoWraper');

          const InfoMainTextElement = document.createElement('a');
          InfoMainTextElement.classList.add('InfoMainTextElement');
          InfoMainTextElement.href = `${baseGoodUrl}${item.id}`;
          InfoMainTextElement.textContent = item.name;
          wrapperInfoElement.appendChild(InfoMainTextElement);

          const wrapperContentElement = document.createElement('div');
          wrapperContentElement.classList.add('cartedGoodsContentElement');
          console.log(item)
          wrapperContentElement.id = `cart-${item.id}`

          wrapperContentElement.appendChild(wrapperImgElement);
          wrapperContentElement.appendChild(wrapperInfoElement);

          cartItemPaymentContainer.appendChild(wrapperContentElement);

          const InfoMainCodeElement = document.createElement('h2');
          InfoMainCodeElement.classList.add('InfoMainCodeElement');
          InfoMainCodeElement.innerHTML = `<div class="InfoMainElementWraper">
              <span class="InfoMainCodeElementLabel">Артикул:</span> 
              <span class="InfoMainCodeElementValue">${item.code}</span>
          </div>`;
          wrapperInfoElement.appendChild(InfoMainCodeElement);

          const InfoMainSizeElement = document.createElement('h2');
          InfoMainSizeElement.classList.add('InfoMainSizeElement');
          InfoMainSizeElement.innerHTML = `<div class="InfoMainElementWraper">
              <span class="InfoMainSizeElementLabel">Розмір:</span> 
              <span class="InfoMainSizeElementValue">${item.size}</span>
          </div>`;
          wrapperInfoElement.appendChild(InfoMainSizeElement);

          const InfoColorMainElement = document.createElement('h2');
          InfoColorMainElement.classList.add('InfoColorMainElement');
          InfoColorMainElement.innerHTML = `<div class="InfoMainElementWraper">
              <span class="InfoColorMainElementLabel">Колір:</span> 
              <span class="InfoColorMainElementValue">${item.color}</span>
          </div>`;
          wrapperInfoElement.appendChild(InfoColorMainElement);

          const InfoPriceColorElement = document.createElement('h2');
          InfoPriceColorElement.classList.add('InfoPriceColorElement');
          InfoPriceColorElement.textContent = "$" + item.price;
          wrapperInfoElement.appendChild(InfoPriceColorElement);

          const InfoElementDeleteButton = document.createElement('button');
          InfoElementDeleteButton.classList.add('InfoElementDeleteButton');
          InfoElementDeleteButton.textContent = "Видалити";
          InfoElementDeleteButton.onclick = function () {
            const converToWithTo = "cart-" + item.id;
            togglePayment(converToWithTo);
          };
          wrapperInfoElement.appendChild(InfoElementDeleteButton);
        });
      }

      if (window.location.pathname.includes('payment')) {
        document.addEventListener('DOMContentLoaded', initializePaymentPageElement);
      }

      document.addEventListener('DOMContentLoaded', function() {
        list = getItemsFromStorageCart()
        const totalPriceValye = document.querySelector('.total-price-valye');

        totalPrice = 0;
        
        list.forEach(item => {
          totalPrice += item.price
        })
        totalPriceValye.innerHTML = totalPrice;
      })




  </script>
  </head>
  <body>
    <div class="center-content">
      <header>
        <div class="header-container">
          <div class="header-block">
            <a href = "{{url_for('home')}}" class="logo">
              <img src="../../static/public/logo.png" alt="" class="logo-img">
            </a>

            <div class="container-like-cart">

              <div class="like-container">
                <button class="like" onclick="toggleDropdownLike(); displayLikedItems(); toggleVisibility('.likeDropdownChild', '.cartDropdownChild')">
                  <img src="../../static/public/likeIcon.png" alt="" class="like-img">
                </button>

                <div class="likes-counter"></div>

                <div class="likeDropdownChild">
                  <div class="containerForLike">
                    <h1 href="">вподобайки</h1>
                    <div onclick = "toggleDropdownLike()"><img src="../../static/public/close.png" alt="" class="close-img"></div>
                  </div>
                  
                  <div class="likedGoodsContainer"></div>

                </div>
              
              </div>

              <div class="cart-container">
                <button class="cart" onclick="toggleDropdownCart(); displayCartedItems(); toggleVisibility('.cartDropdownChild','.likeDropdownChild')">
                  <img src="../../static/public/cartIcon.png" alt="" class="cart-img">
                </button>

                <div class="carts-counter"></div>

                <div class="cartDropdownChild">
                  <div class="containerForCart">
                    <h1 href="">кошик</h1>
                    <botton onclick = "toggleDropdownCart()"><img src="../../static/public/close.png" alt="" class="close-img"></botton>
                  </div>
                  
                  <div class="cartedGoodsContainer"></div>

                </div>
              
              </div>

            

            <!-- <div class="cart-container">
              <a href = "{{url_for('payment')}}" class="like">
                <img src="../../static/public/cartIcon.png" alt="" class="cart-img">
              </a>
              <div class="cart-counter"></div>
            </div> -->


          </div>
        </div>
      </div>
      </header>
</html>
